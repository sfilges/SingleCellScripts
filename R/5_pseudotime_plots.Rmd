---
title: "(5) Trajctories and pseudotime plots"
author: "Stefan Filges"
date: '`r format(Sys.Date())`'
output: 
  html_document:
    theme: sandstone
    highlight: tango
    code_folding: show
    toc: yes
    toc_depth: 3
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load_libraries}
# Packages for main analysis, clustering, data structures etc.
suppressMessages(library(Seurat, quietly = TRUE))
suppressMessages(library(biomaRt, quietly = TRUE))
suppressMessages(library(msigdbr, quietly = TRUE))
suppressMessages(library(clusterProfiler, quietly = TRUE))
suppressMessages(library(SummarizedExperiment, quietly = TRUE))
suppressMessages(require(clusterExperiment, quietly = TRUE))

# Packages for data handeling and plotting
suppressMessages(library(tidyverse, quietly = TRUE))
suppressMessages(library(viridis, quietly = TRUE))
suppressMessages(library(RColorBrewer, quietly = TRUE))

# Packages for pseudotime ordering
suppressMessages(library(slingshot, quietly = TRUE))
suppressMessages(library(monocle, quietly = TRUE))
suppressMessages(library(SCORPIUS, quietly = TRUE))
```

# What does this document do?

This document uses pre-generated single cell data objects containing pseudotime/trajctory information and generates plots for data exploration and analysis. The data sets were generated using a different script, which can take a significant amount of time and is a long document containing code on many other issues. This document allows for faster and easier-to-use analysis.

# Monocle 2

## Load data

First we load a CellDataSet called cds generated with Monocle v2. This contains the expression data, cell metdata (phenotypes) as well as pseudotime values.

```{r import_data}
# define the working directory
working_directory <- "~/GitHub/SingleCellScripts/"

# set other directories based on working directory
figures_dir <- paste(working_directory,"figures/",sep="")
rdata_dir <- paste(working_directory,"data/Rdata/",sep="")

# load object
load(file = paste(rdata_dir, 'seurat_object_final.Rdata', sep = ''))
load(file = paste(rdata_dir, 'cds_monocle2.Rdata', sep = ''))

clustering_DEG_genes = read.csv2(file = paste(working_directory, 'data/gene_lists/monocle2_DEG_genes.csv', sep = ''))
order_genes <- read.csv2(file = paste(working_directory, 'data/gene_lists/ordering_genes.csv', sep = ''))
```

## Cell trajectories

```{r monocle_v2_pseudotime, echo=FALSE}
plot1 <- monocle::plot_cell_trajectory(
  cds = cds,
  color_by = "Pseudotime"
) + scale_color_viridis_c()

plot2 <- monocle::plot_cell_trajectory(
  cds = cds, 
  color_by = "group"
) + scale_color_manual(values = c("#003f5c","#7a5195","#ef5675","#ffa600"))

# Save monocle pseudotime
ggplot2::ggsave(filename = '~/GitHub/SingleCellScripts/figures/monocle_pseudotime.svg', plot = plot1, width = 6, height = 6, device = "svg")
ggplot2::ggsave(filename = '~/GitHub/SingleCellScripts/figures/monocle_pseudotime.pdf', plot = plot1, width = 6, height = 6, device = "pdf")

# Save moncole samples
ggplot2::ggsave(filename = '~/GitHub/SingleCellScripts/figures/monocle_samples.svg', plot = plot2, width = 6, height = 6, device = "svg")
ggplot2::ggsave(filename = '~/GitHub/SingleCellScripts/figures/monocle_samples.pdf', plot = plot2, width = 6, height = 6, device = "pdf")

plot1 + plot2
```

## Expression heatmap

We want to find genes differentially expressed across pseudotime. Instead of
testing all genes, we will limit the number of genes to be tested: (i) First
we select only genes differentially expressed in cluster with an adjusted
p value $<0.01$ and (ii) select the top 500 of those to perform the test. 

After testing we select again based on adjusted p value $<0.01$ to find the 
most significantly expressed genes along the trajectory. These are then visualised
in a heatmap with 

```{r monocle2-heatmap, eval=TRUE, message=FALSE}
clustering_genes <- clustering_DEG_genes %>% 
  dplyr::filter(use_for_ordering == TRUE) %>%
  dplyr::arrange(qval)

to_be_tested <- clustering_genes$gene_short_name[1:1500]

cds_subset <- cds[as.character(to_be_tested),]

diff_test_res <- monocle::differentialGeneTest(
  cds_subset,
  fullModelFormulaStr = "~sm.ns(Pseudotime)"
)

sig_gene_names <- row.names(subset(diff_test_res, qval < 0.01))

heatmap <- monocle::plot_pseudotime_heatmap(
  cds_subset[sig_gene_names,],
  num_clusters = 4,
  cores = 4,
  cluster_rows = TRUE,
  norm_method = 'vstExprs',
  show_rownames = FALSE,
  hmcols = viridis::magma(256),
  return_heatmap = TRUE
) + scale_color_brewer(palette = "Dark2")

pdf(file = '~/GitHub/SingleCellScripts/figures/heatmap_4_clusters.pdf', width = 7,height = 3)
heatmap
dev.off()

# Retrieve gene names + cluster identities
clusters <- cutree(heatmap$tree_row, k = 4)
t <- tibble(
  gene = names(clusters), 
  cluster = clusters
  ) %>%
  arrange(cluster)

readr::write_csv2(t, path = '~/GitHub/SingleCellScripts/data/gene_lists/diff_genes_over_pseudotime_top_1500_q_0.01.csv')
```

```{r}
cds_time <- cds_subset[,order(cds_subset$Pseudotime)]

# red: scf FD - #F8766D
# grÃ¼n: scf WT - #7CAE00
# cyan: xen FD - #00BFC4
# violett: xen WT - #C77CFF

ggplotColours <- function(n = 6, h = c(0, 360) + 15){
  if ((diff(h) %% 360) < 1) h[2] <- h[2] - 360/n
  hcl(h = (seq(h[1], h[2], length = n)), c = 100, l = 65)
}

annotation = list(
  time = cds_time$Pseudotime,
  group = cds_time$group
)
annotation_colors = list(
  time = viridis::viridis(256),
  group =  c("#003f5c","#7a5195","#ef5675","#ffa600")
)

# c("#ff8668", "gray70","#5e8aab","#ffce8e")

NMF::aheatmap(
  x = as.matrix(exprs(cds_time[1:10,])),
  Colv = NA, 
  Rowv = NA, 
  border_color = NA,
  annCol = annotation,
  annColors = annotation_colors,
  scale = 'none',
  width = 5,
  height = 5,
  filename = "~/GitHub/SingleCellScripts/figures/aheatmap_1500_genes.pdf"
)
```

## Plot differentially expressed genes in pseudotime

```{r}
diff_test_res <- diff_test_res %>% 
  dplyr::filter(qval < 0.01) %>%
  dplyr::arrange(qval)

my_genes <- c('CDKN2C', 'LAMA4', 'GAPDH', 'APOE', 'ALDOA')
cds_subset <- cds[my_genes,]

#markers_to_plot <- t %>% dplyr::group_by(cluster) %>% summarise(first = first(gene)) 
#cds_subset <- cds[markers_to_plot$first,]

# Plot by pseudotime
plot1 <- monocle::plot_genes_in_pseudotime(
  cds_subset = cds_subset,
  color_by = "Pseudotime",
  relative_expr = TRUE,
  cell_size = 0.5
) + scale_color_viridis_c() +
  theme(legend.position = 'bottom')

# Plot by sample
plot2 <- monocle::plot_genes_in_pseudotime(
  cds_subset = cds_subset,
  relative_expr = TRUE,
  color_by = "group",
  cell_size = 0.5
  ) + scale_color_manual(values = c("#003f5c","#7a5195","#ef5675","#ffa600")) +
  theme(legend.position = 'bottom')

#+ scale_color_brewer(palette = "Dark2")
#+ scale_color_manual(values = c("#ff8668", "gray70","#5e8aab","#ffce8e"))

plot1 + plot2
```


```{r}
source("helper_functions.R")

cluster_1 <- enrichment_plot(data = t, id = 1)
cluster_2 <- enrichment_plot(data = t, id = 2)
cluster_3 <- enrichment_plot(data = t, id = 3)
cluster_4 <- enrichment_plot(data = t, id = 4)

# Save cluster1 enrichments
ggplot2::ggsave(filename = paste(figures_dir, 'enrichment_cluster_1.svg', sep = ''), plot = cluster_1, width = 12, height = 4, device = "svg")
ggplot2::ggsave(filename = paste(figures_dir, 'enrichment_cluster_1.pdf', sep = ''), plot = cluster_1, width = 12, height = 4, device = "pdf")

# Save cluster2 enrichments
ggplot2::ggsave(filename = paste(figures_dir, 'enrichment_cluster_2.svg', sep = ''), plot = cluster_2, width = 12, height = 4, device = "svg")
ggplot2::ggsave(filename = paste(figures_dir, 'enrichment_cluster_2.pdf', sep = ''), plot = cluster_2, width = 12, height = 4, device = "pdf")

# Save cluster3 enrichments
ggplot2::ggsave(filename = paste(figures_dir, 'enrichment_cluster_3.svg', sep = ''), plot = cluster_3, width = 12, height = 4, device = "svg")
ggplot2::ggsave(filename = paste(figures_dir, 'enrichment_cluster_3.pdf', sep = ''), plot = cluster_3, width = 12, height = 4, device = "pdf")

# Save cluster4 enrichments
ggplot2::ggsave(filename = paste(figures_dir, 'enrichment_cluster_4.svg', sep = ''), plot = cluster_4, width = 12, height = 4, device = "svg")
ggplot2::ggsave(filename = paste(figures_dir, 'enrichment_cluster_4.pdf', sep = ''), plot = cluster_4, width = 12, height = 4, device = "pdf")

```



